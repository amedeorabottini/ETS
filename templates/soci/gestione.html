{% extends "base.html" %}

{% macro semaforo(colore, label=None, tooltip=None) %}
<div class="semaforo semaforo-{{ colore }}"
     {% if tooltip %}title="{{ tooltip }}"{% endif %}>
  {% if label %}
    <span>{{ label }}</span>
  {% endif %}
</div>
{% endmacro %}

{% block content %}

<h2>Gestione Soci</h2>

<!-- ========================= -->
<!-- FILTRI -->
<!-- ========================= -->
<form method="get" style="margin-bottom:15px; display:flex; gap:10px;">
    <select name="anno">
        <option value="">â€” Anno â€”</option>
        {% for a in anni %}
            <option value="{{ a }}"
                {% if a|string == filtri.anno %}selected{% endif %}>
                {{ a }}
            </option>
        {% endfor %}
    </select>

    <input type="text"
           name="q"
           placeholder="Cerca nome / cognome / CF"
           value="{{ filtri.q }}">

    <select name="stato">
        <option value="">Tutti</option>
        <option value="ATTIVO"
            {% if filtri.stato == 'ATTIVO' %}selected{% endif %}>
            Attivi
        </option>
        <option value="USCITO"
            {% if filtri.stato == 'USCITO' %}selected{% endif %}>
            Usciti
        </option>
    </select>

    <button type="submit">Filtra</button>
</form>

<!-- ========================= -->
<!-- ELENCO SOCI -->
<!-- ========================= -->
<table class="table">
    <thead>
    <tr>
        <th>Matricola</th>
        <th>Cognome</th>
        <th>Nome</th>
        <th>Stato</th>

        <th title="Quota annuale">
            <i data-lucide="coins" class="header-icon"></i>
        </th>
        {% for e in enti_affiliazione %}
        <th title="Tesseramento {{ e.nome }}">
            {{ e.codice }}
        </th>
        {% endfor %}
        <th title="Certificato agonistico">
            <i data-lucide="heart-pulse" class="header-icon"></i>
        </th>
        <th title="Certificato non agonistico">
            <i data-lucide="heart" class="header-icon"></i>
        </th>
        <th title="Modulistica">
            <i data-lucide="file-text" class="header-icon"></i>
        </th>

        <th>Azioni</th>
    </tr>
    </thead>

    <tbody>
    {% for s in soci %}
    <tr>
        <td>{{ s.matricola }}</td>
        <td>{{ s.cognome }}</td>
        <td>{{ s.nome }}</td>

        <td class="text-center">
            {% if s.stato == 'ATTIVO' %}
                {{ semaforo("verde", None, "Socio attivo") }}
            {% else %}
                {{ semaforo("rosso", None, "Socio uscito") }}
            {% endif %}
        </td>

        <!-- ðŸ’¶ QUOTA -->
        <td class="text-center">
        {{ semaforo(s.quota_colore, None, s.quota_tooltip) }}
        </td>

       {% for e in enti_affiliazione %}
            {% set t = s.tesseramenti.get(e.id) %}
            <td class="text-center">
                <a href="{{ url_for('tesseramenti_bp.storico_tesseramenti_socio', socio_id=s.id) }}"
                title="Storico tesseramenti {{ e.nome }}"
                style="text-decoration:none;">

                {% if t %}
                    {{ semaforo(t["colore"], t["label"], t["stato"]) }}
                {% else %}
                    {{ semaforo("grigio", None, "Nessun dato tesseramento per questo ente") }}
                {% endif %}

                </a>
            </td>
            {% endfor %}
        <!-- ðŸ«€ CERT. AGONISTICO -->
        <td>
            {% if not filtri.anno %}
                {{ semaforo("grigio", None, "Seleziona un anno") }}
            {% else %}
                {{ semaforo("verde", None, "Certificato valido (stub)") }}
            {% endif %}
        </td>

        <!-- â¤ï¸ CERT. NON AGONISTICO -->
        <td>
            {% if not filtri.anno %}
                {{ semaforo("grigio", None, "Seleziona un anno") }}
            {% else %}
                {{ semaforo("verde", None, "Certificato valido (stub)") }}
            {% endif %}
        </td>

        <!-- ðŸ“„ MODULISTICA -->
        <td>
           {% if not filtri.anno %}
                {{ semaforo("grigio", None, "Seleziona un anno") }}
            {% else %}
                {{ semaforo("verde", None, "Certificato valido (stub)") }}
            {% endif %}
        </td>

        <td style="display:flex; gap:8px; align-items:center;">
            <a href="{{ url_for('dettaglio_socio', socio_id=s.id) }}">Dettaglio</a>

            <form method="post"
                action="{{ url_for('elimina_socio_tutto', socio_id=s.id) }}"
                onsubmit="return confirm('Confermi ELIMINAZIONE TOTALE socio + record collegati?');"
                style="margin:0;">
                <button type="submit" class="btn btn-sm btn-danger">Elimina tutto</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>



<style>
.semaforo {
  min-width: 44px;
  height: 22px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.35),
    inset 0 -1px 0 rgba(0,0,0,0.15);
}

.semaforo-verde {
  background: linear-gradient(180deg, #4ade80, #16a34a);
}

.semaforo-rosso {
  background: linear-gradient(180deg, #f87171, #dc2626);
}

.semaforo-grigio {
  background: linear-gradient(180deg, #d1d5db, #9ca3af);
  color: #374151;
}

.semaforo span {
  padding: 0 6px;
  line-height: 1;
}
</style>


{% endblock %}